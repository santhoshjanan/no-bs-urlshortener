name: DAST Security Scanning

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  schedule:
    # Run weekly on Monday at 01:00 UTC
    - cron: '0 1 * * 1'
  workflow_dispatch:

jobs:
  owasp-zap-baseline-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testing
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo, pdo_pgsql, mbstring, xml, ctype, fileinfo, openssl, tokenizer, json, bcmath

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
          cache: 'npm'

      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
        continue-on-error: true

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install NPM Dependencies
        run: npm ci

      - name: Generate Application Key
        run: php artisan key:generate
        continue-on-error: true

      - name: Run Database Migrations
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: php artisan migrate --force

      - name: Build Frontend Assets
        run: npm run build

      - name: Start Laravel Application
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          APP_ENV: testing
          APP_URL: http://localhost:8000
        run: |
          php artisan serve --host=0.0.0.0 --port=8000 &
          sleep 10
          curl -f http://localhost:8000 || exit 1

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J'
          fail_action: false
        continue-on-error: true

      - name: Check for ZAP SARIF output
        if: always()
        id: zap-sarif
        run: |
          # Check for various possible SARIF output files from ZAP
          if [ -f zap_scan.json ]; then
            echo "sarif_file=zap_scan.json" >> $GITHUB_OUTPUT
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          elif [ -f report_json.json ]; then
            # ZAP might output JSON but not SARIF - skip upload if not SARIF format
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "Note: ZAP generated JSON report but not SARIF format"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "Note: No ZAP SARIF file found"
          fi

      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.zap-sarif.outputs.sarif_exists == 'true'
        with:
          sarif_file: '${{ steps.zap-sarif.outputs.sarif_file }}'
        continue-on-error: true

      - name: ZAP Scan Results
        if: always()
        run: |
          if [ -f zap_scan.json ]; then
            echo "## ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
            cat zap_scan.json | jq -r '.runs[0].results[] | "### \(.ruleId)\n- **Level**: \(.level)\n- **Message**: \(.message.text)\n- **Location**: \(.locations[0].physicalLocation.artifactLocation.uri)\n"' >> $GITHUB_STEP_SUMMARY || true
          fi

  owasp-zap-full-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testing
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo, pdo_pgsql, mbstring, xml, ctype, fileinfo, openssl, tokenizer, json, bcmath

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
          cache: 'npm'

      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
        continue-on-error: true

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install NPM Dependencies
        run: npm ci

      - name: Generate Application Key
        run: php artisan key:generate
        continue-on-error: true

      - name: Run Database Migrations
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: php artisan migrate --force

      - name: Build Frontend Assets
        run: npm run build

      - name: Start Laravel Application
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          APP_ENV: testing
          APP_URL: http://localhost:8000
        run: |
          php artisan serve --host=0.0.0.0 --port=8000 &
          sleep 10
          curl -f http://localhost:8000 || exit 1

      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J'
          fail_action: false
        continue-on-error: true

      - name: Check for ZAP SARIF output
        if: always()
        id: zap-sarif
        run: |
          # Check for various possible SARIF output files from ZAP
          if [ -f zap_scan.json ]; then
            echo "sarif_file=zap_scan.json" >> $GITHUB_OUTPUT
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          elif [ -f report_json.json ]; then
            # ZAP might output JSON but not SARIF - skip upload if not SARIF format
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "Note: ZAP generated JSON report but not SARIF format"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "Note: No ZAP SARIF file found"
          fi

      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.zap-sarif.outputs.sarif_exists == 'true'
        with:
          sarif_file: '${{ steps.zap-sarif.outputs.sarif_file }}'
        continue-on-error: true

